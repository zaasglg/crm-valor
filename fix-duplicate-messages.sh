#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏
echo "üìã –¢–µ–∫—É—â–∏–µ –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫):"
pm2 logs chat-clone --lines 20

echo ""
echo "üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:"
echo "–°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç, –Ω–æ —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç –∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏."
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑-–∑–∞:"
echo "1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤"
echo "2. –ü—Ä–æ–±–ª–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"
echo "3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è message_id"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo ""
echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "chat_clone.db" ]; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞"
    echo "–†–∞–∑–º–µ—Ä: $(ls -lh chat_clone.db | awk '{print $5}')"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    echo "üì® –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î:"
    sqlite3 chat_clone.db "SELECT id, client_id, message_text, created_at FROM messages ORDER BY created_at DESC LIMIT 5;" 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ë–î"
else
    echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

# –û—á–∏—â–∞–µ–º –∫—ç—à –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo ""
echo "üßπ –û—á–∏—â–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫—ç—à–∏..."

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞ –≤ –ø–∞–º—è—Ç–∏
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞..."
pm2 restart chat-clone

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 5

echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:"
pm2 list | grep chat-clone

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Ä–æ–Ω–∫—É
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –≤–æ—Ä–æ–Ω–∫–∏..."
RULES_COUNT=$(curl -s http://localhost:3001/api/automation-rules | jq '. | length' 2>/dev/null || echo "0")
echo "–ü—Ä–∞–≤–∏–ª –≤ —Å–∏—Å—Ç–µ–º–µ: $RULES_COUNT"

if [ "$RULES_COUNT" = "0" ] || [ "$RULES_COUNT" = "null" ]; then
    echo "‚ùå –ü—Ä–∞–≤–∏–ª–∞ –≤–æ—Ä–æ–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!"
    echo "üîß –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ—Ä–æ–Ω–∫—É..."
    node setup-colombia-funnel.js
else
    echo "‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –≤–æ—Ä–æ–Ω–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
fi

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
echo "1. –ù–∞ÔøΩÔøΩ–∏—à–∏—Ç–µ –±–æ—Ç—É –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–µ /start)"
echo "2. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–∏–≤–µ—Ç' –∏–ª–∏ 'Hello'"
echo "3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏: pm2 logs chat-clone -f"
echo ""
echo "–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:"
echo "- –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç C√©sar G√≥mez"
echo "- –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'Duplicate message detected'"

echo ""
echo "üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (–Ω–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞):"
pm2 logs chat-clone -f