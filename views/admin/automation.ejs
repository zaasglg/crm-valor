<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</h3>
      </div>
      <div class="card-body">
        <form id="ruleForm">
          <div class="form-group">
            <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</label>
            <textarea class="form-control" id="instruction" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –ø—Ä–∏–≤–µ—Ç, –æ—Ç–≤–µ—Ç–∏—Ç—å –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!'"></textarea>
          </div>
          <button type="button" class="btn btn-info" onclick="parseInstruction()">
            <i class="fas fa-magic"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
          </button>
          <hr>
          
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞:</label>
            <input type="text" class="form-control" id="ruleName" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
          </div>
          
          <div class="form-group">
            <label>–°–æ–±—ã—Ç–∏–µ:</label>
            <select class="form-control" id="event">
              <option value="message_received">–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ</option>
              <option value="chat_opened">–û—Ç–∫—Ä—ã—Ç —á–∞—Ç</option>
              <option value="chat_closed">–ó–∞–∫—Ä—ã—Ç —á–∞—Ç</option>
              <option value="tag_added">–î–æ–±–∞–≤–ª–µ–Ω —Ç–µ–≥</option>
              <option value="no_reply_timeout">–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</option>
              <option value="file_received">–ü–æ–ª—É—á–µ–Ω —Ñ–∞–π–ª</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>–£—Å–ª–æ–≤–∏—è:</label>
            <div id="conditions">
              <div class="condition-item mb-2">
                <select class="form-control condition-type" style="width: 200px; display: inline-block;">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ</option>
                  <option value="text_contains">–¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                  <option value="has_tag">–ï—Å—Ç—å —Ç–µ–≥</option>
                  <option value="from_channel">–ö–∞–Ω–∞–ª</option>
                  <option value="time_since_last_reply_gt">–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</option>
                  <option value="file_type">–¢–∏–ø —Ñ–∞–π–ª–∞</option>
                </select>
                <input type="text" class="form-control condition-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" style="width: 300px; display: inline-block; margin-left: 10px;">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeCondition(this)">√ó</button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="addCondition()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ</button>
          </div>
          
          <div class="form-group">
            <label>–î–µ–π—Å—Ç–≤–∏—è:</label>
            <div id="actions">
              <div class="action-item mb-2">
                <select class="form-control action-type" style="width: 200px; display: inline-block;">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
                  <option value="add_tag">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</option>
                  <option value="remove_tag">–£–±—Ä–∞—Ç—å —Ç–µ–≥</option>
                  <option value="auto_reply">–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç</option>
                  <option value="send_file">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</option>
                  <option value="assign_to_queue">–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</option>
                  <option value="create_task">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</option>
                </select>
                <input type="text" class="form-control action-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" style="width: 300px; display: inline-block; margin-left: 10px;">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeAction(this)">√ó</button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="addAction()">+ –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</button>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
          </button>
        </form>
        
        <div id="json-preview" class="mt-4" style="display: none;">
          <h5>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä JSON:</h5>
          <pre id="json-output" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px;"></pre>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞</h3>
      </div>
      <div class="card-body">
        <div id="rules-list"></div>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">–ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</h3>
      </div>
      <div class="card-body">
        <div class="example-instructions">
          <button class="btn btn-outline-secondary btn-sm btn-block mb-2" onclick="setInstruction('–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –ø—Ä–∏–≤–µ—Ç, –æ—Ç–≤–µ—Ç–∏—Ç—å –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏!')">
            –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
          </button>
          <button class="btn btn-outline-secondary btn-sm btn-block mb-2" onclick="setInstruction('–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–ª–∞—Ç–∞, –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥ billing')">
            –¢–µ–≥ –ø–æ –æ–ø–ª–∞—Ç–µ
          </button>
          <button class="btn btn-outline-secondary btn-sm btn-block mb-2" onclick="setInstruction('–ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ 30 –º–∏–Ω—É—Ç, —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞')">
            –ó–∞–¥–∞—á–∞ –ø—Ä–∏ –º–æ–ª—á–∞–Ω–∏–∏
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function setInstruction(text) {
  document.getElementById('instruction').value = text;
}

function parseInstruction() {
  const instruction = document.getElementById('instruction').value.trim();
  if (!instruction) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é');
    return;
  }
  
  fetch('/api/parse-rule', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ instruction })
  })
  .then(res => res.json())
  .then(rule => {
    document.getElementById('ruleName').value = rule.name;
    document.getElementById('event').value = rule.event;
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —É—Å–ª–æ–≤–∏—è
    const conditionsDiv = document.getElementById('conditions');
    conditionsDiv.innerHTML = '';
    for (const [key, value] of Object.entries(rule.condition || {})) {
      addCondition(key, value);
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
    const actionsDiv = document.getElementById('actions');
    actionsDiv.innerHTML = '';
    for (const [key, value] of Object.entries(rule.action || {})) {
      addAction(key, value);
    }
    
    updateJsonPreview();
  })
  .catch(err => {
    console.error('Error:', err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏');
  });
}

function addCondition(type = '', value = '') {
  const div = document.createElement('div');
  div.className = 'condition-item mb-2';
  div.innerHTML = `
    <select class="form-control condition-type" style="width: 200px; display: inline-block;" onchange="updateJsonPreview()">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ</option>
      <option value="text_contains" ${type === 'text_contains' ? 'selected' : ''}>–¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç</option>
      <option value="has_tag" ${type === 'has_tag' ? 'selected' : ''}>–ï—Å—Ç—å —Ç–µ–≥</option>
      <option value="from_channel" ${type === 'from_channel' ? 'selected' : ''}>–ö–∞–Ω–∞–ª</option>
      <option value="time_since_last_reply_gt" ${type === 'time_since_last_reply_gt' ? 'selected' : ''}>–í—Ä–µ–º—è –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</option>
      <option value="file_type" ${type === 'file_type' ? 'selected' : ''}>–¢–∏–ø —Ñ–∞–π–ª–∞</option>
    </select>
    <input type="text" class="form-control condition-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${value}" style="width: 300px; display: inline-block; margin-left: 10px;" oninput="updateJsonPreview()">
    <button type="button" class="btn btn-sm btn-danger" onclick="removeCondition(this)">√ó</button>
  `;
  document.getElementById('conditions').appendChild(div);
}

function addAction(type = '', value = '') {
  const div = document.createElement('div');
  div.className = 'action-item mb-2';
  div.innerHTML = `
    <select class="form-control action-type" style="width: 200px; display: inline-block;" onchange="updateJsonPreview()">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
      <option value="add_tag" ${type === 'add_tag' ? 'selected' : ''}>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</option>
      <option value="remove_tag" ${type === 'remove_tag' ? 'selected' : ''}>–£–±—Ä–∞—Ç—å —Ç–µ–≥</option>
      <option value="auto_reply" ${type === 'auto_reply' ? 'selected' : ''}>–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç</option>
      <option value="send_file" ${type === 'send_file' ? 'selected' : ''}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</option>
      <option value="assign_to_queue" ${type === 'assign_to_queue' ? 'selected' : ''}>–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</option>
      <option value="create_task" ${type === 'create_task' ? 'selected' : ''}>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</option>
    </select>
    <div style="display: inline-block; margin-left: 10px;">
      <input type="text" class="form-control action-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${typeof value === 'object' ? value.name || '' : value}" style="width: 200px; display: inline-block;" oninput="updateJsonPreview()">
      <input type="file" class="form-control action-file" style="width: 100px; display: none; margin-left: 5px;" onchange="uploadActionFile(this)">
      <button type="button" class="btn btn-sm btn-info" onclick="toggleFileUpload(this)" style="margin-left: 5px;">üìÅ</button>
    </div>
    <button type="button" class="btn btn-sm btn-danger" onclick="removeAction(this)">√ó</button>
  `;
  document.getElementById('actions').appendChild(div);
}

function removeCondition(btn) {
  btn.parentElement.remove();
  updateJsonPreview();
}

function removeAction(btn) {
  btn.parentElement.remove();
  updateJsonPreview();
}

function updateJsonPreview() {
  const rule = buildRuleFromForm();
  document.getElementById('json-output').textContent = JSON.stringify(rule, null, 2);
  document.getElementById('json-preview').style.display = 'block';
}

function buildRuleFromForm() {
  const rule = {
    id: "auto",
    name: document.getElementById('ruleName').value || "–ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ",
    event: document.getElementById('event').value,
    condition: {},
    action: {}
  };
  
  // –°–æ–±–∏—Ä–∞–µ–º —É—Å–ª–æ–≤–∏—è
  document.querySelectorAll('.condition-item').forEach(item => {
    const type = item.querySelector('.condition-type').value;
    const value = item.querySelector('.condition-value').value;
    if (type && value) {
      rule.condition[type] = value;
    }
  });
  
  // –°–æ–±–∏—Ä–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è
  document.querySelectorAll('.action-item').forEach(item => {
    const type = item.querySelector('.action-type').value;
    const valueInput = item.querySelector('.action-value');
    const value = valueInput.value;
    
    if (type && value) {
      if (type === 'send_file' && valueInput.dataset.filePath) {
        rule.action[type] = {
          name: value,
          path: valueInput.dataset.filePath
        };
      } else {
        rule.action[type] = value;
      }
    }
  });
  
  return rule;
}

document.getElementById('ruleForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const rule = buildRuleFromForm();
  
  fetch('/api/automation-rules', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(rule)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('–ü—Ä–∞–≤–∏–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      loadRules();
      document.getElementById('ruleForm').reset();
      document.getElementById('json-preview').style.display = 'none';
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞');
    }
  });
});

function loadRules() {
  fetch('/api/automation-rules')
    .then(res => res.json())
    .then(rules => {
      const container = document.getElementById('rules-list');
      container.innerHTML = rules.map(rule => `
        <div class="rule-item mb-2 p-2" style="border: 1px solid #dee2e6; border-radius: 4px;">
          <strong>${rule.name}</strong><br>
          <small class="text-muted">${rule.event}</small>
          <button class="btn btn-sm btn-danger float-right" onclick="deleteRule('${rule.id}')">√ó</button>
        </div>
      `).join('');
    });
}

function deleteRule(id) {
  if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ?')) {
    fetch(`/api/automation-rules/${id}`, { method: 'DELETE' })
      .then(() => loadRules());
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º JSON –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã
document.getElementById('ruleName').addEventListener('input', updateJsonPreview);
document.getElementById('event').addEventListener('change', updateJsonPreview);

function toggleFileUpload(btn) {
  const actionItem = btn.closest('.action-item');
  const select = actionItem.querySelector('.action-type');
  const fileInput = actionItem.querySelector('.action-file');
  
  if (select.value === 'send_file') {
    fileInput.style.display = fileInput.style.display === 'none' ? 'inline-block' : 'none';
  } else {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª" –≤ –¥–µ–π—Å—Ç–≤–∏–∏');
  }
}

function uploadActionFile(input) {
  const file = input.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('file', file);
  
  fetch('/api/upload-automation-file', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const actionItem = input.closest('.action-item');
      const valueInput = actionItem.querySelector('.action-value');
      valueInput.value = data.fileName;
      valueInput.dataset.filePath = data.filePath;
      updateJsonPreview();
    } else {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
  });
}

loadRules();
</script>