<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Управление сотрудниками</h3>
        <div class="card-tools">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">
            <i class="fas fa-plus"></i> Добавить сотрудника
          </button>
        </div>
      </div>
      <div class="card-body">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Логин</th>
              <th>Роль</th>
              <th>Создан</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="users-list">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Добавить сотрудника</h4>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <form id="userForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Логин</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="form-group">
            <label>Пароль</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <div class="form-group">
            <label>Роль</label>
            <select class="form-control" id="role">
              <option value="operator">Оператор</option>
              <option value="admin">Админ</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Создать</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let users = [];

function loadUsers() {
  fetch('/api/users')
    .then(res => res.json())
    .then(data => {
      users = data;
      renderUsers();
    });
}

function renderUsers() {
  const tbody = document.getElementById('users-list');
  tbody.innerHTML = users.map(user => `
    <tr>
      <td>${user.id}</td>
      <td>${user.username}</td>
      <td><span class="badge ${user.role === 'admin' ? 'badge-danger' : 'badge-info'}">${user.role === 'admin' ? 'Админ' : 'Оператор'}</span></td>
      <td>${new Date(user.created_at).toLocaleString()}</td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
          <i class="fas fa-trash"></i> Удалить
        </button>
      </td>
    </tr>
  `).join('');
}

function deleteUser(id) {
  if (confirm('Удалить сотрудника?')) {
    fetch(`/api/users/${id}`, { method: 'DELETE' })
      .then(() => loadUsers());
  }
}

document.getElementById('userForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = {
    username: document.getElementById('username').value,
    password: document.getElementById('password').value,
    role: document.getElementById('role').value
  };

  fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  }).then(() => {
    $('#addUserModal').modal('hide');
    document.getElementById('userForm').reset();
    loadUsers();
  });
});

loadUsers();
</script>