<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Чаты | CRM Система</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
  <style>
    .chat-container { height: calc(100vh - 56px); display: flex; }
    .clients-sidebar { height: 100%; overflow-y: auto; }
    .client-item { padding: 15px; border-bottom: 1px solid #dee2e6; cursor: pointer; transition: all 0.3s ease; }
    .client-item:hover { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); transform: translateX(5px); }
    .client-item.active { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
    .client-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .client-info h6 { margin: 0; font-size: 14px; font-weight: 600; }
    .client-info small { color: #6c757d; font-size: 12px; }
    .client-item.active .client-info h6 { color: #ffffff; }
    .client-item.active .client-info small { color: rgba(255,255,255,0.9); }
    .clusters-display { margin-top: 5px; }
    .clusters-display span { display: inline-block !important; margin-right: 3px !important; }
    .client-item.active .clusters-display span { opacity: 0.9; }
    .chat-main { flex: 1; display: flex; flex-direction: column; }
    .chat-area { flex: 1; display: flex; flex-direction: column; }
    .chat-header { position: sticky; top: 0; z-index: 100; padding: 20px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .messages-container { flex: 1; padding: 20px; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); }
    .message { margin-bottom: 20px; display: flex; animation: fadeInUp 0.3s ease; }
    .message.in { justify-content: flex-start; }
    .message.out { justify-content: flex-end; }
    .message-bubble { max-width: 70%; padding: 12px 18px; border-radius: 6px; position: relative; }
    .message.in .message-bubble { background: white; border: 1px solid #e9ecef; }
    .message.out .message-bubble { background: #007bff; color: white; }
    .message-time { font-size: 11px; opacity: 0.7; margin-top: 8px; }
    .input-area { position: sticky; bottom: 0; z-index: 100; padding: 20px; background: white; border-top: 1px solid #dee2e6; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .no-chat { display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-size: 18px; }
    .client-sidebar { position: fixed; right: 0; top: 56px; width: 350px; background: white; border-left: 1px solid #dee2e6; height: calc(100vh - 56px); overflow-y: auto; transform: translateX(100%); transition: transform 0.3s ease; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1000; }
    .client-sidebar.open { transform: translateX(0); }
    .sidebar-header { padding: 20px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; }
    .sidebar-content { padding: 20px; }
    .user-profile { display: flex; align-items: center; margin-bottom: 25px; }
    .user-avatar-large { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; margin-right: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
    .stat-item { text-align: center; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 15px; border: 1px solid #e9ecef; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s ease; }
    .stat-item:hover { transform: translateY(-2px); }
    .stat-number { font-size: 24px; font-weight: bold; color: #007bff; margin-bottom: 5px; }
    .stat-label { font-size: 12px; color: #6c757d; font-weight: 500; }
    .info-section { margin: 25px 0; }
    .info-section h3 { margin: 0 0 20px 0; font-size: 18px; color: #495057; font-weight: 600; }
    .info-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f3f4; }
    .info-item:last-child { border-bottom: none; }
    .info-item-label { color: #6c757d; font-size: 14px; font-weight: 500; }
    .info-item-value { color: #495057; font-size: 14px; font-weight: 600; }
    .cluster-btn { padding: 8px 15px; border: 2px solid; background: white; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.3s ease; margin: 3px; }
    .cluster-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .selected-clusters { margin: 15px 0; min-height: 40px; }
    .btn-save { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40,167,69,0.3); }
    .btn-save:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40,167,69,0.4); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item">
        <span class="navbar-text">Чаты с клиентами</span>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="fas fa-user"></i> <span id="username-display"></span>
        </a>
        <div class="dropdown-menu dropdown-menu-right">
          <a href="/admin/dashboard" class="dropdown-item" id="admin-link" style="display: none;">
            <i class="fas fa-cogs mr-2"></i> Админ панель
          </a>
          <div class="dropdown-divider" id="admin-divider" style="display: none;"></div>
          <a href="/logout" class="dropdown-item">
            <i class="fas fa-sign-out-alt mr-2"></i> Выход
          </a>
        </div>
      </li>
    </ul>
  </nav>

  <!-- Main Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <i class="fas fa-comments brand-image img-circle elevation-3" style="opacity: .8; margin-left: 10px;"></i>
      <span class="brand-text font-weight-light">Чаты</span>
    </a>

    <div class="sidebar">
      <div class="clients-sidebar">
        <div class="p-3">
          <div class="input-group">
            <input type="text" class="form-control form-control-sm" placeholder="Поиск клиентов..." id="search-clients">
            <div class="input-group-append">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
          </div>
        </div>
        <div id="clients-list"></div>
      </div>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper p-0">
    <div class="chat-container">
      <div class="chat-main">
        <div class="chat-area" id="chat-area">
          <div class="no-chat">
            <div class="text-center">
              <i class="fas fa-comments fa-3x mb-3"></i>
              <h4>Выберите клиента</h4>
              <p class="text-muted">Выберите клиента из списка слева для начала общения</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right Sidebar for Client Card -->
      <div class="client-sidebar" id="client-sidebar">
        <div class="sidebar-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Карточка клиента</h5>
            <button class="btn btn-sm btn-outline-light" onclick="closeClientSidebar()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="sidebar-content" id="sidebar-content">
          <!-- Контент карточки будет загружаться динамически -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User Card Modal -->
<div class="modal fade" id="userCardModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Карточка клиента</h4>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="user-card-content">
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
// Проверка авторизации
const user = JSON.parse(localStorage.getItem('user') || 'null');
if (!user) {
  window.location.href = '/login';
}

// Отображение пользователя
document.getElementById('username-display').textContent = user.username;
if (user.role === 'admin') {
  document.getElementById('admin-link').style.display = 'block';
  document.getElementById('admin-divider').style.display = 'block';
}

const socket = io();
let currentClientId = null;
let clients = {};
let allClients = {};

// Socket events
socket.on('new_message', (data) => {
  const hasAccess = user.role === 'admin' || 
                   data.client_assigned_to === user.username || 
                   !data.client_assigned_to;
  
  if (!hasAccess) return;
  
  if (!clients[data.client_id]) {
    clients[data.client_id] = { 
      id: data.client_id, 
      name: data.client_name, 
      assigned_to: data.client_assigned_to,
      messages: [] 
    };
    renderClients();
  }
  
  if (!clients[data.client_id].messages) {
    clients[data.client_id].messages = [];
  }
  
  clients[data.client_id].messages.push(data.message);
  
  if (currentClientId === data.client_id) {
    renderMessages();
  }
  
  // Обновляем превью последнего сообщения
  updateClientPreview(data.client_id, data.message);
});

// Обработка уведомлений автоматизации
socket.on('automation_notification', (data) => {
  const hasAccess = user.role === 'admin' || 
                   clients[data.client_id]?.assigned_to === user.username || 
                   !clients[data.client_id]?.assigned_to;
  
  if (!hasAccess) return;
  
  showAutomationNotification(data);
});

function showAutomationNotification(data) {
  // Создаем уведомление
  const notification = document.createElement('div');
  notification.className = 'alert alert-info alert-dismissible fade show';
  notification.style.cssText = `
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-left: 4px solid #007bff;
  `;
  
  notification.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas fa-robot mr-2 text-primary"></i>
      <div class="flex-grow-1">
        <strong>${data.client_name}</strong><br>
        <small>${data.message}</small>
      </div>
      <button type="button" class="close" data-dismiss="alert">
        <span>&times;</span>
      </button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Автоматически скрываем через 5 секунд
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

function selectClient(clientId) {
  currentClientId = clientId;
  
  // Обновляем активный элемент
  document.querySelectorAll('.client-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`[data-client-id="${clientId}"]`)?.classList.add('active');
  
  // Показываем чат
  showChatArea(clientId);
  loadMessages(clientId);
}

function showChatArea(clientId) {
  const client = clients[clientId] || allClients[clientId];
  if (!client) return;
  
  const chatArea = document.getElementById('chat-area');
  chatArea.innerHTML = `
    <div class="chat-header">
      <div class="d-flex align-items-center">
        <div class="client-avatar mr-3">
          ${(client.name || 'U').charAt(0).toUpperCase()}
        </div>
        <div class="flex-grow-1">
          <h5 class="mb-0">${client.name || 'Неизвестный клиент'}</h5>
          <small class="text-muted">
            Telegram ${client.assigned_to ? '• Назначен: ' + client.assigned_to : ''}
          </small>
        </div>
        <button class="btn btn-outline-primary btn-sm" onclick="openClientSidebar(${clientId})">
          <i class="fas fa-info-circle"></i>
        </button>
      </div>
    </div>
    <div class="messages-container" id="messages-container"></div>
    <div class="input-area">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Введите сообщение..." id="message-input">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-paperclip"></i>
          </button>
          <button class="btn btn-primary" type="button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
      <input type="file" id="file-input" style="display: none;">
    </div>
  `;
  
  // Обработчики событий
  document.getElementById('message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
  
  document.getElementById('file-input').addEventListener('change', handleFileUpload);
}

function loadMessages(clientId) {
  fetch(`/api/messages/${clientId}`)
    .then(res => res.json())
    .then(messages => {
      if (Array.isArray(messages)) {
        clients[clientId] = clients[clientId] || {};
        clients[clientId].messages = messages;
      } else {
        clients[clientId] = clients[clientId] || {};
        clients[clientId].messages = [];
      }
      renderMessages();
    })
    .catch(err => {
      console.error('Error loading messages:', err);
      clients[clientId] = clients[clientId] || {};
      clients[clientId].messages = [];
      renderMessages();
    });
}

function renderMessages() {
  const container = document.getElementById('messages-container');
  if (!container || !currentClientId) return;
  
  const messages = clients[currentClientId]?.messages || [];
  
  container.innerHTML = messages.map(msg => {
    let content = msg.text || '';
    if (msg.file_url) {
      content += `<br><a href="${msg.file_url}" target="_blank" class="text-decoration-none">
        <i class="fas fa-file"></i> ${msg.file_name}
      </a>`;
    }
    
    return `
      <div class="message ${msg.direction}">
        <div class="message-bubble">
          <div>${content}</div>
          <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
        </div>
      </div>
    `;
  }).join('');
  
  container.scrollTop = container.scrollHeight;
}

function renderClients() {
  const container = document.getElementById('clients-list');
  const clientsList = Object.values(clients);
  
  container.innerHTML = clientsList.map(client => `
    <div class="client-item" data-client-id="${client.id}" onclick="selectClient(${client.id})">
      <div class="d-flex align-items-center">
        <div class="client-avatar">
          ${(client.name || 'U').charAt(0).toUpperCase()}
        </div>
        <div class="client-info flex-grow-1">
          <h6>${client.name || 'Неизвестный клиент'}</h6>
          <small>
            Telegram ${client.assigned_to ? '• ' + client.assigned_to : ''}
          </small>
          <div class="clusters-display" style="margin-top: 5px;">
            ${getClientClustersHTML(client)}
          </div>
          <div class="last-message" id="preview-${client.id}"></div>
        </div>
      </div>
    </div>
  `).join('');
}

function updateClientPreview(clientId, message) {
  const previewEl = document.getElementById(`preview-${clientId}`);
  if (previewEl) {
    const text = message.text || (message.file_name ? `📁 ${message.file_name}` : '');
    const shortText = text.length > 30 ? text.substring(0, 30) + '...' : text;
    previewEl.innerHTML = `<small class="text-muted">${shortText}</small>`;
  }
}

function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  if (!text || !currentClientId) return;
  
  fetch('/api/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ client_id: currentClientId, text, operator: user.username })
  }).then(() => {
    input.value = '';
    loadMessages(currentClientId);
  });
}

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (file && currentClientId) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('client_id', currentClientId);
    formData.append('operator', user.username);
    
    fetch('/api/send-file', {
      method: 'POST',
      body: formData
    }).then(() => {
      e.target.value = '';
      loadMessages(currentClientId);
    });
  }
}

function openClientSidebar(clientId) {
  fetch('/user-card-fragment')
    .then(res => res.text())
    .then(html => {
      // Обновляем HTML для сайдбара
      const updatedHtml = html
        .replace(/onclick="saveClientData\(\)"/g, 'onclick="saveClientData()" class="btn-save"')
        .replace(/style="[^"]*"/g, '')
        .replace(/<div class="info-item">/g, '<div class="info-item">')
        .replace(/<div class="info-item" style="flex-direction: column; align-items: flex-start;">/g, '<div class="info-item" style="flex-direction: column; align-items: flex-start;">');
      
      document.getElementById('sidebar-content').innerHTML = updatedHtml;
      
      // Загружаем данные клиента
      fetch(`/api/clients`).then(r => r.json()).then(clientsData => {
        const client = clientsData.find(c => c.id == clientId);
        if (client) {
          document.getElementById('modal-user-name').textContent = client.name || 'Неизвестный клиент';
          document.getElementById('modal-user-id').textContent = client.id;
          document.getElementById('modal-external-id').textContent = client.external_id;
          document.getElementById('modal-assigned-to').textContent = client.assigned_to || 'Не назначен';
          document.getElementById('modal-created-at').textContent = new Date(client.created_at).toLocaleString();
          document.getElementById('modal-user-comment').value = client.comment || '';
          
          // Загружаем кластеры
          let clusters = [];
          try {
            clusters = client.cluster ? JSON.parse(client.cluster) : [];
          } catch (e) {
            clusters = client.cluster ? [client.cluster] : [];
          }
          console.log('Loading clusters for client:', client.id, clusters);
          window.setClientClusters(clusters);
          
          const avatar = document.getElementById('modal-user-avatar');
          avatar.textContent = (client.name || 'U').charAt(0).toUpperCase();
        }
        

      });
      
      // Открываем сайдбар
      document.getElementById('client-sidebar').classList.add('open');
    });
}

function closeClientSidebar() {
  document.getElementById('client-sidebar').classList.remove('open');
}

function openUserCard(clientId) {
  openClientSidebar(clientId);
}

function saveComment() {
  saveClientData();
}

function saveClientData() {
  const comment = document.getElementById('modal-user-comment').value.trim();
  const clusters = window.getSelectedClusters ? window.getSelectedClusters() : [];
  
  if (!currentClientId) {
    alert('Клиент не выбран');
    return;
  }
  
  console.log('Saving data:', { clientId: currentClientId, comment, clusters });
  
  Promise.all([
    fetch('/api/update-client-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ client_id: currentClientId, comment })
    }),
    fetch('/api/update-client-cluster', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ client_id: currentClientId, cluster: JSON.stringify(clusters) })
    })
  ])
  .then(responses => Promise.all(responses.map(r => r.json())))
  .then(results => {
    if (results.every(r => r.success)) {
      alert('Данные сохранены');
      if (clients[currentClientId]) {
        clients[currentClientId].comment = comment;
        clients[currentClientId].cluster = JSON.stringify(clusters);
        clients[currentClientId].parsedClusters = clusters;
      }
      // Обновляем отображение в списке
      renderClients();
      renderClients();
    } else {
      alert('Ошибка при сохранении данных');
    }
  })
  .catch(error => {
    console.error('Error saving data:', error);
    alert('Ошибка при сохранении');
  });
}

// Поиск клиентов
document.getElementById('search-clients').addEventListener('input', (e) => {
  const search = e.target.value.toLowerCase();
  document.querySelectorAll('.client-item').forEach(item => {
    const name = item.querySelector('.client-info h6').textContent.toLowerCase();
    item.style.display = name.includes(search) ? 'block' : 'none';
  });
});

function getClientClustersHTML(client) {
  const clusters = client.parsedClusters || [];
  console.log(`Rendering clusters for client ${client.id}:`, clusters);
  
  if (!Array.isArray(clusters) || clusters.length === 0) {
    console.log(`No clusters to display for client ${client.id}`);
    return '';
  }
  
  const colors = {
    'VIP': '#007bff',
    'Постоянный': '#28a745',
    'Новый': '#17a2b8',
    'Проблемный': '#dc3545',
    'Активный': '#ffc107'
  };
  
  return clusters.map(cluster => 
    `<span style="background: ${colors[cluster] || '#6c757d'}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-right: 3px; display: inline-block;">${cluster}</span>`
  ).join('');
}

// Глобальные функции для работы с кластерами
let selectedClusters = [];

window.toggleCluster = function(cluster) {
  const index = selectedClusters.indexOf(cluster);
  const btn = document.querySelector(`[data-cluster="${cluster}"]`);
  
  if (index > -1) {
    selectedClusters.splice(index, 1);
    btn.style.background = 'white';
    btn.style.color = btn.style.borderColor;
  } else {
    selectedClusters.push(cluster);
    btn.style.background = btn.style.borderColor;
    btn.style.color = 'white';
  }
  
  updateSelectedClusters();
};

window.updateSelectedClusters = function() {
  const container = document.getElementById('selected-clusters');
  if (!container) return;
  
  if (selectedClusters.length === 0) {
    container.innerHTML = '<span style="color: #6c757d; font-size: 12px;">Кластеры не выбраны</span>';
  } else {
    const colors = {
      'VIP': '#007bff',
      'Постоянный': '#28a745',
      'Новый': '#17a2b8',
      'Проблемный': '#dc3545',
      'Активный': '#ffc107'
    };
    
    container.innerHTML = selectedClusters.map(cluster => 
      `<span style="background: ${colors[cluster]}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px; margin-bottom: 3px; display: inline-block;">${cluster}</span>`
    ).join('');
  }
};

window.setClientClusters = function(clusters) {
  selectedClusters = clusters || [];
  
  // Сбрасываем все кнопки
  document.querySelectorAll('.cluster-btn').forEach(btn => {
    btn.style.background = 'white';
    btn.style.color = btn.style.borderColor;
  });
  
  // Активируем выбранные
  selectedClusters.forEach(cluster => {
    const btn = document.querySelector(`[data-cluster="${cluster}"]`);
    if (btn) {
      btn.style.background = btn.style.borderColor;
      btn.style.color = 'white';
    }
  });
  
  updateSelectedClusters();
};

window.getSelectedClusters = function() {
  return selectedClusters;
};

// Загрузка клиентов
fetch('/api/clients')
  .then(res => res.json())
  .then(data => {
    if (Array.isArray(data)) {
      data.forEach(client => {
        allClients[client.id] = client;
        if (user.role === 'admin' || 
            client.assigned_to === user.username || 
            !client.assigned_to) {
          // Парсим кластеры при загрузке
          try {
            if (client.cluster && typeof client.cluster === 'string') {
              client.parsedClusters = JSON.parse(client.cluster);
              console.log(`Client ${client.id} clusters:`, client.parsedClusters);
            } else {
              client.parsedClusters = [];
            }
          } catch (e) {
            console.error('Error parsing clusters for client', client.id, e);
            client.parsedClusters = [];
          }
          clients[client.id] = client;
        }
      });
    }
    console.log('Loaded clients:', Object.keys(clients).length);
    renderClients();
  })
  .catch(err => {
    console.error('Error loading clients:', err);
    renderClients();
  });
</script>
</body>
</html>