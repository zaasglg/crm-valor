#!/bin/bash

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤..."

# –ò—â–µ–º –∫–æ–¥, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
echo "üìù –ü–æ–∏—Å–∫ –ª–æ–≥–∏–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –∫–æ–¥–µ..."

if grep -n "Duplicate message detected" server.js; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ server.js"
    echo ""
    echo "üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–¥–∞:"
    grep -B 5 -A 5 "Duplicate message detected" server.js
elif grep -n "Duplicate message detected" telegram.js; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ telegram.js"
    echo ""
    echo "üìã –ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–¥–∞:"
    grep -B 5 -A 5 "Duplicate message detected" telegram.js
else
    echo "‚ùå –õ–æ–≥–∏–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö"
    echo "–ü–æ–∏—Å–∫ –≤–æ –≤—Å–µ—Ö .js —Ñ–∞–π–ª–∞—Ö..."
    find . -name "*.js" -exec grep -l "Duplicate message detected" {} \;
fi

echo ""
echo "üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
echo ""
echo "1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:"
echo "   - –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å 'Duplicate message detected'"
echo "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"
echo ""
echo "2. –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à message_id:"
echo "   - –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î –∏–ª–∏ –∫—ç—à–∞"
echo "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"
echo ""
echo "3. –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"
echo "   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é message_id + timestamp"

echo ""
echo "üõ†Ô∏è –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:"
read -p "–û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤? (y/n): " disable_duplicates

if [ "$disable_duplicates" = "y" ] || [ "$disable_duplicates" = "Y" ]; then
    echo "üîß –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤..."
    
    # –°–æ–∑–¥–∞–µ–º backup
    cp server.js server.js.backup
    
    # –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    sed -i 's/.*Duplicate message detected.*/        \/\/ &/' server.js
    
    # –¢–∞–∫–∂–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º return, –∫–æ—Ç–æ—Ä—ã–π –∏–¥–µ—Ç –ø–æ—Å–ª–µ —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    sed -i '/Duplicate message detected/,/return/ s/^[[:space:]]*return/        \/\/ return/' server.js
    
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞"
    echo "üìÅ Backup —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ server.js.backup"
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
    pm2 restart chat-clone
    
    echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É."
else
    echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π"
fi

echo ""
echo "üß™ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs chat-clone -f"
echo "3. –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç C√©sar G√≥mez"